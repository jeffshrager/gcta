from numpy import matmul
import math
import json

# wm = [[-1.8818214703549612, 1.5241552803993375, 1.5985980641083479, 1.1695069858104565, 7.760124875652636, 0.2638195544515845, 1.418551041112692, 5.9278159779853548, 1.2084598364208212, 7.1553825238713156, 5.1772720855101486], [-2.5826600794249361, -3.8135400601348661, -3.4160738690651677, 5.5353362135884172, -0.031180632321739843, -3.6286814541169452, 4.8382301137143724, -1.1466603648959142, -3.3663280280216279, 0.03148660200251796, 0.50522844053541949], [-0.40394152398758065, 0.2495871137719374, 3.7165131877687565, 2.3741025715540314, 1.6240439970302569, 4.1311215934379195, 1.455633667136369, 2.7140769106515648, 3.2667109937095145, 1.2661779911310205, 4.9419470088137363], [-1.2145574534088213, 2.3724790007475187, 1.185162351732661, 0.50085782465723572, 2.0591068539512949, -0.10377696934264624, -0.34351262471110955, 2.1586800945514066, 3.7699289933891493, 5.9853792407708859, 2.0341582423834619], [0.99327867804041026, -0.59682048563710433, 0.35453474158777132, 1.0183549121944824, 1.017708378434768, 2.9785675498558173, 3.4744223208972032, 3.8259502552675633, 1.4827052677346748, 0.59535924310662869, 2.7722764835709377], [0.83036572105826023, 1.792987138188727, 2.786316598735084, 4.0221823696439865, 5.6005102644771974, 1.6712212831946145, 1.1724001143899421, 1.5863349229334638, 1.4039863540179767, 2.949564488909477, 2.9665783293497157]]

def sigmoid(x, h):
    #cliff is huge at 10 and good at 1 and a line at 0.1
    return 1/(1+math.exp(-h*x))

def score_matrix(wm):
    params = json.load(open('params.json', 'r'))
    drugs_dict = params['drugs']
    drugs_lookup_list = ['BEVACIZUMAB', 'TEMOZOLOMIDE', 'CABAZITAXEL', 'TCAR', 'DISATINIB', 'NIVOLUMAB', 'DOXORUBICIN', 'DURVALUMAB', 'PEMBROLIZUMAB', 'VARLILUMAB', 'SORAFENIB']
    markers_lookup_list = ['MGMT-PROMOTER', 'HLA-A2', 'HLA-A1', 'IDH2', 'IDH1', 'EGFR']

    markers_to_drugs = dict(zip(markers_lookup_list, [[] for i in range(len(markers_lookup_list))]))
    for drug in drugs_dict:
        for marker in drugs_dict[drug]['markers']:
            markers_to_drugs[marker].append(drug)

    markers_to_tumors = {'EGFR': [0, 0, 0, 0, 0, 1], 'IDH1': [0, 0, 0, 0, 1, 0], 'IDH2': [0, 0, 0, 1, 0, 0], 'HLA-A1': [0, 0, 1, 0, 0, 0], 
                        'HLA-A2': [0, 1, 0, 0, 0, 0], 'MGMT-PROMOTER': [1, 0, 0, 0, 0, 0]}

    for marker in markers_to_tumors:
        res = matmul(markers_to_tumors[marker], wm)
        pairs = [(drugs_lookup_list[i], res[i]) for i in range(len(res))]
        pairs.sort(key=lambda x: x[1])
        pairs.reverse()
        print('================================================================================')
        print(marker)
        print(markers_to_drugs[marker])
        print(pairs)